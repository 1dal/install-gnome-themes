#!/bin/bash

#
# This script installs the latest versions of some fine GNOME themes into the current user's ".themes" folder.
#
# Get the most recent version of this script at:
#
#     https://github.com/tliron/install-gnome-themes
#
# Copyright 2016 by Tal Liron. MIT-style license:
#
#     https://github.com/tliron/install-gnome-themes/blob/master/LICENSE
#

set -e

#
# To skip installation of requirements:
#
# 	REQUIREMENTS=0 ./install-gnome-themes
#
# Build output is supressed by default. If you want to see it, set the LOG environment var:
#
# 	LOG=/dev/stdout ./install-gnome-themes
#
# Or:
#
# 	LOG=output.log ./install-gnome-themes
#

BLUE='\033[0;34m'
CYAN='\033[0;36m'
RED='\033[0;31m'
RESET='\033[0m'

LOG=${LOG:-/dev/null}
REQUIREMENTS=${REQUIREMENTS:-1}
THEMES=~/.themes
CACHE_FILE=${CACHE_FILE:-$THEMES/.install-gnome-themes-cache}
WORK=/tmp/install-gnome-themes

#
# Preparation
#

function message()
{
	COLOR=${2:-$CYAN}
	echo -e "${COLOR}$@$RESET"
	if [ "$LOG" != '/dev/stdout' ]; then
		echo "$1" >> "$LOG"
	fi
}

GNOME_VERSION=$(gnome-shell --version | cut --delimiter=' ' --fields=3 | cut --delimiter='.' --fields=1,2)

if [ "$GNOME_VERSION" != '3.20' ] && [ "$GNOME_VERSION" != '3.18' ]; then
	message "This script only supports GNOME 3.20 and GNOME 3.18."
	exit 1
fi

message "Detected GNOME $GNOME_VERSION."

OS=$(lsb_release --id --short)

message "Detected $OS operating system."

if [ "$REQUIREMENTS" == 1 ]; then
	message "Verifying that build requirements are installed..."

	if [ "$OS" == 'Ubuntu' ] || [ "$OS" == 'Debian' ]; then
		# Ubuntu GNOME comes with Numix (for 3.18) preinstalled, we will remove it to avoid confusion
		sudo apt remove numix-gtk-theme
		# Install our build and usage requirements
		sudo apt install \
			git autoconf automake pkg-config parallel \
			libgtk-3-dev libgdk-pixbuf2.0-dev libglib2.0-dev libglib2.0-bin \
			libxml2-utils librsvg2-dev \
			gnome-themes-standard gtk2-engines-murrine gtk2-engines-pixbuf \
			ruby ruby-bundler \
			inkscape \
			fonts-roboto-hinted fonts-noto-hinted
	else
		message "This script only supports Ubuntu and Debian." "$RED"
		exit 1
	fi

	# sass is used by many themes to generate CSS
	sudo gem install sass

	# sassc is used specifically by Adapta
	if [ ! -f /usr/bin/sassc ]; then
		echo "Building and installing sassc..."
		rm --recursive --force "$WORK/libsass" "$WORK/sassc"
		mkdir --parents "$WORK"
		cd "$WORK"
		git clone https://github.com/sass/libsass.git --depth 1 libsass &>> "$LOG"
		git clone https://github.com/sass/sassc.git --depth 1 sassc &>> "$LOG"
		cd "$WORK/sassc"
		SASS_LIBSASS_PATH="$WORK/libsass" make --jobs="$(nproc)" &>> "$LOG"
		sudo cp "$WORK/sassc/bin/sassc" /usr/bin/
		rm --recursive --force "$WORK/libsass" "$WORK/sassc"
	fi
fi

mkdir --parents "$THEMES"

#
# Utilities
#

function repository-timestamp()
{
	git log --max-count=1 --date=short --pretty=format:%cr
}

function repository-id()
{
	git log --max-count=1 --pretty=format:%H
}

function get-value() # [key] [db]
{
	local KEY=$1
	local DB=$2
	if [ -f "$DB" ]; then
		sed --quiet "s/^$KEY \(.*\)/\1/p" "$DB"
	fi
}

function set-value() # [key] [value] [db]
{
	local KEY=$1
	local VALUE=$2
	local DB=$3
	if grep --quiet --no-messages "^$KEY " "$DB"; then
		sed --in-place "s/^\($KEY \)\(.*\)/\1$VALUE/" "$DB"
	else
		echo "$KEY $VALUE" >> "$DB"
	fi
}

function comma-separated()
{
	local R
	for A in "$@"; do
		if [ -z "$R" ]; then
			R=$1
		else
			R="$R, $A"
		fi
	done
	echo $R
}

function prepare() # [account] [repo] [branch] [themes...]
{
	local ACCOUNT=$1
	local REPO=$2
	local BRANCH=$3

	local URL="https://github.com/$ACCOUNT/$REPO"
	local KEY="$ACCOUNT|$REPO|$BRANCH"
	local LAST_ID=$(get-value "$KEY" "$CACHE_FILE")
	local NAMES=$(comma-separated "${@:4}")

	message "Fetching repository: $URL..."

	# Shallow git clone
	cleanup "$REPO"
	mkdir --parents "$WORK"
	cd "$WORK"
	git clone "$URL" --branch "$BRANCH" --depth 1 "$REPO" &>> "$LOG"
	cd "$WORK/$REPO"

	local CURRENT_ID=$(repository-id)
	if [ "$CURRENT_ID" == "$LAST_ID" ]; then
		message "$NAMES:"
		message "  Last updated $(repository-timestamp)."
		message "  Already installed."
		cleanup "$REPO"
		return 1
	else
		message "$NAMES:" "$BLUE"
		message "  Last updated $(repository-timestamp)." "$BLUE"
		message "  Installing..." "$BLUE"
		if [ "$REPO" == Adapta ]; then
			message "  WARNING: Installation takes an especially long time due to rendering of all assets, please be patient!" "$BLUE"
		fi
		set-value "$KEY" "$CURRENT_ID" "$CACHE_FILE"
		cd "$THEMES"
		rm --recursive --force "${@:4}"
		cd "$WORK/$REPO"
		return 0
	fi
}

function cleanup() # [repo]
{
	local REPO=$1
	rm --recursive --force "$WORK/$REPO"
}

function theme-cp() # [account] [repo] [branch] [themes...]
{
	local REPO=$2
	if ! prepare "$@"; then
		return
	fi
	cp --recursive "${@:4}" "$THEMES/"
	cleanup "$REPO"
}

function theme-mv() # [account] [repo] [branch] [theme]
{
	local REPO=$2
	local THEME=$4
	if ! prepare "$@"; then
		return
	fi
	mv "$WORK/$REPO" "$THEMES/$THEME"
	cleanup "$REPO"
}

function theme-run() # [account] [repo] [branch] [cmd]
{
	local REPO=$2
	local COMMAND=$4
	if ! prepare "$@"; then
		return
	fi
	cd "$WORK/$REPO"
	"./$COMMAND" &>> "$LOG"
	cleanup "$REPO"
}

function theme-make() # [account] [repo] [branch] [theme]
{
	local REPO=$2
	local THEME=$4
	if ! prepare "$@"; then
		return
	fi
	make install INSTALL_DIR="$THEMES/$THEME" &>> "$LOG"
	cleanup "$REPO"
}

function theme-autogen-prefix() # [account] [repo] [branch] [themes...]
{
	local REPO=$2
	if ! prepare "$@"; then
		return
	fi
	./autogen.sh --enable-parallel --prefix=$(pwd) $AUTOGEN_ARGS &>> "$LOG"
	make &>> "$LOG"
	# Adapta needs to run "make install" separately
	make install &>> "$LOG"
	cp --recursive "$WORK/$REPO/share/themes/"* "$THEMES/"
	cleanup "$REPO"
}

function theme-autogen-destdir() # [account] [repo] [branch] [themes...]
{
	local REPO=$2
	if ! prepare "$@"; then
		return
	fi
	./autogen.sh --enable-parallel $AUTOGEN_ARGS &>> "$LOG"
	make install DESTDIR=$(pwd) &>> "$LOG"
	cp --recursive "$WORK/$REPO/usr/share/themes/"* "$THEMES/"
	cleanup "$REPO"
}

#
# Themes
#

# Adapta
# https://github.com/tista500/Adapta
# Requirements: autoconf automake inkscape libgdk-pixbuf2.0-dev libglib2.0-dev librsvg2-dev libsass0 libxml2-utils pkg-config sassc  
#
# Supports configurations settings, e.g. a variant with colors red500, red300, bluegrey300, bluegrey500:
#
#	ADAPTA_ARGS='
#		--with-selection_color=#F44336
#		--with-second_selection_color=#E57373
#		--with-accent_color=#90A4AE
#		--with-suggestion_color=#607D8B' \
#	./install-gnome-themes
AUTOGEN_ARGS="--disable-flashback --disable-unity --disable-xfce --disable-mate --disable-openbox --enable-chrome $ADAPTA_ARGS" \
theme-autogen-prefix tista500 Adapta master Adapta Adapta-Eta Adapta-Nokto Adapta-Nokto-Eta

# Arc
# https://github.com/horst3180/arc-theme
# Requirements: autoconf automake pkg-config libgtk-3-dev gtk2-engines-murrine
#
# Supports configurations settings, e.g. a variant with transparency disabled:
#
#	ARC_ARGS='
#		--disable-transparency' \
#	./install-gnome-themes
AUTOGEN_ARGS=$ARC_ARGS \
theme-autogen-prefix horst3180 arc-theme master Arc Arc-Dark Arc-Darker

# Arc-Red
# https://github.com/mclmza/arc-theme-Red
# Requirements: autoconf automake pkg-config libgtk-3-dev gtk2-engines-murrine
#
# Supports configurations settings, e.g. a variant with transparency disabled:
#
#       ARC_RED_ARGS='
#               --disable-transparency' \
#       ./install-gnome-themes
AUTOGEN_ARGS=$ARC_RED_ARGS \
theme-autogen-prefix mclmza arc-theme-Red master Arc-Red Arc-Red-Dark Arc-Red-Darker

# Breeze
# https://github.com/dirruk1/gnome-breeze
# Requirements: gtk2-engines-pixbuf
theme-cp dirruk1 gnome-breeze master Breeze-gtk Breeze-dark-gtk

# Candra
# https://github.com/killhellokitty/Candra-Themes-3.20
# Requirements: gnome-themes-standard gtk2-engines-murrine gtk2-engines-pixbuf
if [ "$GNOME_VERSION" = '3.20' ]; then
	theme-cp killhellokitty Candra-Themes-3.20 master Candra-Theme-3.20 Candra-Theme-3.20-Dark Candra-Theme-3.20-Darker
fi

# Ceti-2
# https://github.com/horst3180/ceti-2-theme
# Requirements: autoconf automake pkg-config libgtk-3-dev gtk2-engines-murrine
if [ "$GNOME_VERSION" = '3.18' ]; then
	theme-autogen-prefix horst3180 ceti-2-theme master Ceti-2
fi

# Chrome-OS
# https://github.com/Elbullazul/Chrome-OS
if [ "$GNOME_VERSION" = '3.18' ]; then
	theme-mv Elbullazul Chrome-OS master Chrome-OS
fi

# Cloak
# https://github.com/killhellokitty/Cloak-3.20
# Requirements: gnome-themes-standard gtk2-engines-murrine gtk2-engines-pixbuf
if [ "$GNOME_VERSION" = '3.20' ]; then
	theme-cp killhellokitty Cloak-3.20 master Cloak-3.20
fi

# Delorean Dark
# https://github.com/killhellokitty/DeLorean-Dark-3.18
# Requirements: gnome-themes-standard gtk2-engines-murrine gtk2-engines-pixbuf
if [ "$GNOME_VERSION" = '3.18' ]; then
	theme-cp killhellokitty DeLorean-Dark-3.18 master DeLorean-Dark-3.18
fi

# EvoPop
# https://github.com/solus-cold-storage/evopop-gtk-theme
theme-autogen-destdir solus-cold-storage evopop-gtk-theme master evopop

# Flat-Plat
# https://github.com/nana-4/Flat-Plat
theme-mv nana-4 Flat-Plat "$GNOME_VERSION" Flat-Plat

# Fresh-Finesse
# https://github.com/Vistaus/Fresh-Finesse
theme-cp Vistaus Fresh-Finesse master Fresh-Finesse 

# Greybird
# https://github.com/shimmerproject/Greybird
# Requirements: autoconf automake libgdk-pixbuf2.0-dev libglib2.0-bin sass
theme-autogen-prefix shimmerproject Greybird master Greybird

# macOS-Sierra
# https://github.com/Elbullazul/macOS-Sierra
theme-mv Elbullazul macOS-Sierra master macOS-Sierra

# Numix
# https://github.com/numixproject/numix-gtk-theme
# Requirements: automake libglib2.0-bin libgdk-pixbuf2.0-dev sass
theme-make numixproject numix-gtk-theme master Numix

# Paper
# https://github.com/snwh/paper-gtk-theme
# Requirements: automake automake
theme-autogen-destdir snwh paper-gtk-theme master Paper

# Redmond-Themes
# https://github.com/Elbullazul/Redmond-Themes
if [ "$GNOME_VERSION" = '3.20' ]; then
	theme-cp Elbullazul Redmond-Themes master "Windows 3.x" "Windows 9x"
elif [ "$GNOME_VERSION" = '3.18' ]; then
	theme-cp Elbullazul Redmond-Themes master "Windows 3.x" "Windows 9x" "Windows XP Embedded" "Windows XP Zune" "Windows Vista"
fi

# Vertex
# https://github.com/horst3180/vertex-theme
# Requirements: autoconf automake pkg-config libgtk-3-dev gtk2-engines-murrine
theme-autogen-prefix horst3180 vertex-theme master Vertex Vertex-Light Vertex-Dark

# Vimix
# https://github.com/vinceliuice/vimix-gtk-themes
# Requirements: gtk2-engines-murrine gtk2-engines-pixbuf
theme-run vinceliuice vimix-gtk-themes master Install

# Zuki
# https://github.com/lassekongo83/zuki-themes
# Requirements: gtk2-engines-murrine gtk2-engines-pixbuf fonts-roboto
if [ "$GNOME_VERSION" = '3.20' ]; then
	theme-cp lassekongo83 zuki-themes master Zukitre Zukitwo Zuki-shell
elif [ "$GNOME_VERSION" = '3.18' ]; then
	theme-cp lassekongo83 zuki-themes 3.18 Zukitre Zukitwo Zuki-shell
fi

message "Done!"
